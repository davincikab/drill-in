 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>

    <style>
        *{font-family:Montserrat,Montserrat,sans-serif;padding:0;margin:0;box-sizing:border-box;z-index:1}body{padding:0;margin:0}#map-container{position:relative;width:100%;height:100vh}#map{height:100%;width:100%;z-index:0;position:relative;outline:0}.county:hover{fill-opacity:0.5}.county.active{fill-opacity:0.2}.county.active:hover{fill-opacity:0.2}.leaflet-bar.leaflet-control{box-shadow:0 1px 5px rgb(0 0 0 / 65%);border-radius:4px}.leaflet-touch .leaflet-bar a{width:26px;height:26px;line-height:26px}.leaflet-marker-pane .count-marker div{width:220px;padding:.6rem .8rem;color:#fff;background-color:#539542B3;background-color:#318ce7b6;pointer-events:none}.leaflet-marker-pane .count-marker div span.state{font-size:14px;font-weight:700;text-transform:uppercase}.leaflet-popup-content-wrapper{border-radius:5px}.leaflet-popup-content{margin:0;width:auto!important}.aside-testimonial{height:auto;flex:1;width:280px;padding:0;background-color:#65768a;color:#fff}.testimonial-title{display:flex;align-items:center;flex-direction:column;font-weight:500;font-size:1rem}.testimonial-title hr{width:50px;height:1px;background-color:#424242;margin:5px 0}.user-review{padding:.5rem;padding:.8rem 2rem;position:relative;margin:.75rem 0}.user-review p{margin:0;font-size:1.2em}.user-review::before{position:absolute;top:-5px;left:10px;content:" ";width:20px;height:20px;color:#fff;font-size:3rem;color:#fff;background:center/contain no-repeat url(https://www.triangle-energie.com/assets/triangleenergie/71424514eb4819b3f2b54ab9687f6767.svg)}.user-review::after{position:absolute;bottom:-5px;right:10px;content:" ";width:20px;height:20px;color:#fff;font-size:3rem;color:#fff;background:center/contain no-repeat url(https://www.triangle-energie.com/assets/triangleenergie/32e6ce3f3d23a0d85f658c0e3b879b0a.svg)}.popup-content .aside-testimonial img{height:150px}.popup-content img{height:120px;width:100%}.popup-content .content{flex:1;padding:.5rem;width:300px;position:relative}.content .content-header{display:flex;flex-direction:column;align-items:center}.popup-content{display:flex;width:auto}.popup-content .state{font-size:1rem;font-weight:700;text-transform:uppercase}.count-state{text-align:center;font-size:1rem;color:#333}.count-marker div span{display:block;width:100%}#map-container #backBtn{position:absolute;top:80px;left:0;display:flex;box-shadow:0 0 .25rem #222;justify-content:center;align-items:center;border-radius:0 5px 5px 0;padding:6px 10px;line-height:1;background-color:#fff;z-index:99;cursor:pointer;transition:background-color .2s ease-in-out}.link-section{position:absolute;bottom:10%;left:0;font-size:1rem;width:100%;padding:5px;font-size:1em;display:flex;align-items:center;justify-content:center}div .btn-link{text-decoration:none;padding:.5rem .75rem;width:80%;margin:.5rem auto;background:#65768a;color:#fff!important;text-align:center}@media screen and (max-width:480px){.popup-content{display:flex}.aside-testimonial{display:none}.popup-content .content{width:200px}}
    </style>

    <div class="map-container" id="map-container">
        <div id="backBtn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 402.9 400.4">
            <path d="M66 104l38.2-3.6v-25l-5.6-20 12.8 1 8.1-1.5-.5 13.3 27 7.2 16.4-5.1-1-6.2 37.3-20.4 10.2-33.2 27-8.7 6.2 13.8h9.2l3 13.8 25.6 9.7 2 12.3 8.7 5 10.2-8.6 2.6 14.8 16.8 11.2 11.2 3.6 11.8.5L358 92.7l42.4 9.7-13.3 19.4-1.5 39.4-7.2 10.2-9.7-4.6-1 6.1-29.6 37.8-.5 8.2-5.6 8.6 10.2 1 1.5-10.7 13.3-1s5.6 27 8.7 23c-4.1-.5-6.2 8.7-6.2 8.7l10.7 19.9-8.1 5.6-9.2 2 9.2 14.3 2.5 8.2-3.5 10.7 12.2 12.3 14.8-1.5 1.6 5.6-6.7 12.7-6.1-2-2 4-3.6.6-2 6.1-3.6-.5-13.3 11.3-.5 6-26 3.7-14.4-6.2-1.5-4.6-8.2-1 2-8.7-7-3.5-7.2 10.7-7.2-5.1-10.7-1-6.1-6.2-17.9 12.8h-6.6l-11.8 17.9 2.6 6-1 11.8-13.3 8.2-12.3-7.1-8.7 3-9.7-6.6-.5-5.1-5-3.6h-6.7L155.3 369l-5.6 4-15.4 1.6-55.1-22.5 2.5-6-15.8-7.2L95 279.6l8.7-38.3v-33.2l-28.6-29.6 2-16.3-18.9-20-54-28.5 13.7-3.6-13.8-9.7 13.3-11.2s31.1-.6 35.2-3.1C54.6 91.7 66 104 66 104z" fill="#65768a" stroke="#fff" stroke-miterlimit="10" stroke-width="3"></path>
            </svg>
            <span>Reset</span>
        </div>

        <div id="map"></div>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.2.1/d3.min.js" integrity="sha512-wkduu4oQG74ySorPiSRStC0Zl8rQfjr/Ty6dMvYTmjZw6RS5bferdx8TR7ynxeh79ySEp/benIFFisKofMjPbg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const config={iconUrl:'https://davincikab.github.io/drill-in/icons/pin.svg',icon2Url:'https://www.triangle-energie.com/assets/triangleenergie/icon/pin_ronde.svg',statesRef:{"bretagne":[48.748945343432936,-6.229248046875001],"normandie":[50.24720490139267,-3.9221191406250004],"hauts_de_france":[51.16556659836182,.49438476562500006],"grand_est":[49.23912083246701,4.801025390625001],"pays_de_la_loire":[47.17477833929906,-5.570068359375001],"centre_val_de_loire":[47.41322033016904,-.27465820312500006],"bourgogne-franche-comté":[47.41322033016904,5.394287109375],"nouvelle_aquitaine":[45.583289756006316,-3.3947753906250004],"occitanie":[43.644025847699496,-.31860351562500006],"auvergne_rhone_alpes":[45.67548217560647,4.053955078125001],"provence_alpes_cote_dazur":[44.040218713142146,6.009521484375],"ile_de_france":[0,0],"corse":[0,0]}};const map=L.map('map',{center:[46.58150100708008,2.4609055519104004],zoom:6,minZoom:6,maxZoom:12,doubleClickZoom:!1,scrollWheelZoom:!1,maxBoundsViscosity:0,zoomControl:!1});let points=[];const zoomControl=L.control.zoom();const resetBtn=document.getElementById("backBtn");resetBtn.addEventListener("click",function(e){e.stopPropagation();resetView()});L.tileLayer("https://{s}.tile.openstreetmap.fr/openriverboatmap/{z}/{x}/{y}.png",{attribution:"© OSM Contributors - tiles OpenRiverboatMap",transparent:!0,opacity:.7}).addTo(map);let tipIcon=L.divIcon({className:'',html:''});let tooltipMarker=L.marker([0,0],{icon:tipIcon}).bindTooltip("")
var activeRegion;function getFillColor(feature){let color='#65768a';if(activeRegion&&activeRegion.properties.nom==feature.properties.nom){color='#fff'}
return color}
const regionsJson=L.geoJSON(null,{onEachFeature:function(feature,layer){layer.on('click',function(e){console.log(e.latlng);if(activeRegion&&activeRegion!==feature){map.panTo(e.latlng);updateCountyPoints(feature)}else{map.setZoomAround(e.latlng,9);updateCountyPoints(feature)}
activeRegion=feature;updateFillColor(e)});layer.on('mouseover',function(e){tooltipMarker.setLatLng(e.latlng).setTooltipContent(feature.properties.nom)});layer.on('mouseleave',function(e){})},style:function(feature){return{fillColor:getFillColor(feature),fillOpacity:0.8,color:'#ddd',weight:2,className:'county'}}}).addTo(map);const nonClickIcon=L.icon({iconUrl:config.iconUrl,iconSize:L.point(15.47,30)});const pntIcons=L.icon({iconUrl:config.icon2Url,iconSize:L.point(15.47,30)});const regionPoints=L.geoJSON(null,{onEachFeature:function(feature,layer){},pointToLayer:function(feature,latLng){let popupContent=getPopupContent(feature);let icon=feature.properties.clickable=="TRUE"?pntIcons:nonClickIcon;let marker=L.marker(latLng,{icon:icon});if(feature.properties.clickable=="TRUE"){marker.bindPopup(popupContent)}
return marker}}).addTo(map);function getPopupContent(feature){let{count,image_1,image_2}=feature.properties;console.log("Popup");return `<div class="popup-content">
        <div class="aside-testimonial">
            <div class="img-header">
                <img src="${image_1 || 'https://picsum.photos/200/100' }" alt="home" />
            </div>

            <div class="testimonial-title">
                <span>
                    <font style="vertical-align: inherit;">
                        <font style="vertical-align: inherit;">Philippe Geeraerts</font>
                    </font>
                </span>
                <hr>
                <span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cereal</font></font></span>
            </div>

            <div class="user-review">
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec semper augue sed posuere condimentum. 
                    Praesent varius risus at risus gravida, non auctor massa ullamcorper.
                </p>
            </div>
        </div>

        <div class="content">
            <div class="content-header">
                <span class="state">${feature.properties.Title}</span>
                <div class="count-state"><font style="vertical-align: inherit;">
                    <font style="vertical-align: inherit;">${count} ${count>1?"Bâtiments":"Bâtiment"}</font></font>
                </div>
            </div>

            <div class="content-body">
                <img src="${image_2 || 'https://picsum.photos/200/100' }" alt="home" />

                <div>
                    <div><b>Region</b><div>
                    <div>${feature.properties.Region}</div>
                    <div><b>Description</b><div>
                    <div>${feature.properties.Description}</div>
                </div>

                <div class="link-section">
                    <a href="#" class="btn-link">LEARN MORE</a>
                </div>
                
            </div>
        </div>
        <div>

        </div>
    </div>`}
const divIcons=function(name,count){const s=`<div style=""><span class="state">${name}</span><span>${count} ${count>1?"Bâtiments":"Bâtiment"}</span></div>`;return L.divIcon({html:s,className:"count-marker"})}
const countPoints=L.geoJSON(null,{pointToLayer:function(feature,latLng){let popupContent=""
return L.marker(latLng,{icon:divIcons(feature.properties.nom,feature.properties.count)})}}).addTo(map)
fetch('https://davincikab.github.io/drill-in/county.geojson').then(res=>res.json()).then(data=>{regionsJson.addData(data)}).catch(console.error)
d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vTEF_IRgsIsNx2MGYj313bILCMJTwBACGLFloALbN8HJCAO-CgVx2QlwwYYECCTNZricqZrGcgGh1KM/pub?gid=0&single=true&output=csv').then(data=>{points=data;let pnts=updateCountsData(data);let geoPnts=getPointGeojson(pnts);countPoints.addData(geoPnts);points=points.map(pnt=>{let pt=pnts.find(a=>a.nom==pnt.Region.toLocaleLowerCase());if(pt){pnt.count=pt.count}else{pnt.count=0}
return pnt})}).catch(console.error);function zoomToBounds(layer){map.fitBounds(layer.getBounds())}
function updateCountsData(points){console.log(points);return Object.keys(config.statesRef).map(state=>{let[Latitude,Longitude]=config.statesRef[state];let pnts=points.filter(pnt=>pnt.Region.toLowerCase()==state);let count=pnts.length;return{count,nom:state.split('_').join(" "),Latitude,Longitude}})}
function updateFillColor(e){regionsJson.eachLayer(layer=>{layer.getElement().classList.remove("active")});e.target.getElement().classList.add("active")}
function getPointGeojson(items){function getFeature(feature){return{'type':'Feature','geometry':{'type':'Point','coordinates':[parseFloat(feature.Longitude),parseFloat(feature.Latitude)]},'properties':{...feature}}};return{'type':'FeatureCollection','features':[...items.map(getFeature)]}}
function updateCountyPoints(feature){let data=points.filter(pnt=>pnt.Region==feature.properties.nom);let pGeo=getPointGeojson(data);console.log(pGeo);regionPoints.clearLayers();regionPoints.addData(pGeo)}
function resetView(){console.log("Reset View");map.setMinZoom(6);map.setView([46.58150100708008,2.4609055519104004],6);map.scrollWheelZoom.disable();regionPoints.clearLayers();regionsJson.eachLayer(layer=>{layer.getElement().classList.remove("active")});activeRegion=null}
map.on('zoomend',function(e){let zoom=map.getZoom();if(zoom>6){map.addControl(zoomControl);map.scrollWheelZoom.enable();map.setMinZoom(8);map.removeLayer(countPoints)}else{map.removeControl(zoomControl);map.addLayer(countPoints)}})
    </script>